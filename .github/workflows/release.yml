name: Release

on:
  push:
    branches:
      - main
      - maintenance/net8

concurrency:
  group: release
  cancel-in-progress: false

# Minimal top-level permissions, defined per job
permissions: {}

jobs:
  # Build, test, and prepare release artifacts
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required for semantic-release to create tags/releases

    outputs:
      has-packages: ${{ steps.check-packages.outputs.has-packages }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 'lts/*'

      - name: Cache NuGet packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Cache npm
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests with coverage
        run: |
          dotnet test --configuration Release --no-build \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage \
            --settings coverage.runsettings

      - name: Generate coverage report
        env:
          REPORTGENERATOR_LICENSE: ${{ secrets.REPORTGENERATOR_LICENSE }}
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:"coverage/**/coverage.opencover.xml" \
            -targetdir:"coverage/report" \
            -reporttypes:"HtmlInline_AzurePipelines;Cobertura;MarkdownSummaryGithub" \
            -title:"ErikLieben.FA.StronglyTypedIds Coverage Report" \
            -license:"$REPORTGENERATOR_LICENSE"

      - name: Upload coverage for SonarCloud
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-data
          path: coverage/**/coverage.opencover.xml
          retention-days: 1

      - name: Upload coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-report
          path: coverage/report
          retention-days: 90

      - name: Add coverage summary to job
        run: cat coverage/report/SummaryGithub.md >> $GITHUB_STEP_SUMMARY

      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release

      - name: Check for packages
        id: check-packages
        run: |
          if [ -d "release-artifacts" ] && ls release-artifacts/*.nupkg 1> /dev/null 2>&1; then
            echo "has-packages=true" >> $GITHUB_OUTPUT
          else
            echo "has-packages=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload release artifacts
        if: steps.check-packages.outputs.has-packages == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: release-artifacts
          path: release-artifacts/
          retention-days: 1

  # SonarCloud analysis (runs in parallel with snyk)
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Java (for SonarCloud)
        uses: actions/setup-java@c1e323688fd81a25caa38c78aa6df2d33d3e20d9 # v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache NuGet packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Cache SonarCloud packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Install SonarCloud scanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Restore dependencies
        run: dotnet restore

      - name: Download coverage data
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: coverage-data
          path: coverage

      - name: Begin SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"eriklieben_ErikLieben.FA.StronglyTypedIds" \
            /o:"eriklieben" \
            /d:sonar.token="$SONAR_TOKEN" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="coverage/**/coverage.opencover.xml"

      - name: Build (required for SonarCloud)
        run: dotnet build --configuration Release --no-restore

      - name: End SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="$SONAR_TOKEN"

  # Snyk security scanning (runs in parallel with sonarcloud)
  snyk:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: '10.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/*.props') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Setup Snyk
        uses: snyk/actions/setup@9adf32b1121593767fc3c057af55b55db032dc04 # master

      - name: Snyk Open Source (dependency vulnerabilities)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --file=ErikLieben.FA.StronglyTypedIds.sln || true
        continue-on-error: true

      - name: Snyk Code (SAST)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk code test || true
        continue-on-error: true

      - name: Monitor project in Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk monitor --file=ErikLieben.FA.StronglyTypedIds.sln || true
        continue-on-error: true

  # Publish to NuGet (only if packages were created)
  publish:
    name: Publish to NuGet
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.has-packages == 'true'

    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          dotnet-version: '10.0.x'

      - name: Download release artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: release-artifacts
          path: release-artifacts

      - name: Generate SBOM
        run: |
          dotnet tool install --global CycloneDX
          dotnet CycloneDX ErikLieben.FA.StronglyTypedIds.sln --output release-artifacts --filename sbom.json --json

      - name: Generate build attestations
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-path: 'release-artifacts/*.nupkg'

      - name: Generate SBOM attestations
        if: hashFiles('release-artifacts/sbom.json') != ''
        uses: actions/attest-sbom@bd218ad0dbcb3e146bd073d1d9c6d78e08aa8a0b # v2
        with:
          subject-path: 'release-artifacts/*.nupkg'
          sbom-path: 'release-artifacts/sbom.json'

      - name: Upload SBOM to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "Uploading SBOM to release $LATEST_TAG"
            gh release upload "$LATEST_TAG" release-artifacts/sbom.json --clobber
          else
            echo "No release tag found, skipping SBOM upload"
          fi

      - name: NuGet Trusted Publishing Login
        uses: NuGet/login@d22cc5f58ff5b88bf9bd452535b4335137e24544 # v1
        id: nuget-login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Push to NuGet.org
        run: |
          for package in release-artifacts/*.nupkg release-artifacts/*.snupkg; do
            if [ -f "$package" ]; then
              echo "Pushing $package to NuGet.org..."
              dotnet nuget push "$package" --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
            fi
          done

      - name: Generate Job Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          for pkg in release-artifacts/*.nupkg; do
            if [ -f "$pkg" ]; then
              filename=$(basename "$pkg" .nupkg)
              name=$(echo "$filename" | sed 's/\.[0-9].*$//')
              version=$(echo "$filename" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+.*')
              echo "| $name | \`$version\` |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Published to: **NuGet.org**" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM generated" >> $GITHUB_STEP_SUMMARY
          echo "- Build attestations created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security & Quality" >> $GITHUB_STEP_SUMMARY
          echo "- [SonarCloud](https://sonarcloud.io/project/overview?id=eriklieben_ErikLieben.FA.StronglyTypedIds)" >> $GITHUB_STEP_SUMMARY
          echo "- [Snyk Dashboard](https://app.snyk.io)" >> $GITHUB_STEP_SUMMARY
